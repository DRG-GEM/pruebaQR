<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Asistencia con QR Dinámico</title>
    <!-- Librerías externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ESTILOS CRÍTICOS */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; } /* Fondo suave */
        .hidden { display: none !important; }
        .app-logo { max-height: 100px; width: auto; margin: 0 auto 1.5rem auto; }
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow: hidden; }
        
        /* Spinner de carga */
        .lds-dual-ring { display: inline-block; width: 80px; height: 80px; }
        .lds-dual-ring:after {
            content: " "; display: block; width: 64px; height: 64px; margin: 8px;
            border-radius: 50%; border: 6px solid #fff;
            border-color: #4f46e5 transparent #4f46e5 transparent;
            animation: lds-dual-ring 1.2s linear infinite;
        }
        @keyframes lds-dual-ring { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #qr-timer-bar { height: 4px; background-color: #4f46e5; width: 100%; }
        button:disabled { opacity: 0.7; cursor: not-allowed; }

        /* Estilos para Toasts (Notificaciones) */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            min-width: 250px;
            padding: 16px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            animation: slideIn 0.3s ease-out;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .toast-success { background-color: #10b981; } /* Verde */
        .toast-error { background-color: #ef4444; }   /* Rojo */
        .toast-info { background-color: #3b82f6; }    /* Azul */
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Contenedor Principal -->
    <div id="app" class="container mx-auto p-4 md:p-8 max-w-4xl min-h-screen">
        <div id="loading-screen" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
             <div class="lds-dual-ring"></div>
        </div>

        <!-- Contenedor de Notificaciones -->
        <div id="toast-container"></div>

        <!-- Vista de Acceso Dirección (Login Google) -->
        <div id="role-selection-view" class="hidden h-full flex flex-col justify-center">
            <div class="bg-white p-10 rounded-3xl shadow-xl text-center max-w-md mx-auto w-full mt-10 transform transition-all hover:scale-105 duration-300">
                <img src="https://web.virgendelpasico.net/wp-content/uploads/2024/01/cropped-ncoop-scaled-1-300x253.jpg" alt="Logo Virgen del Pasico" class="app-logo">
                
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Control de Asistencia</h1>
                <p class="text-gray-500 mb-8 font-medium">Panel de Dirección</p>
                
                <div class="flex flex-col gap-4 justify-center">
                    <button onclick="loginWithGoogle()" class="w-full bg-white text-gray-700 font-bold py-4 px-6 rounded-xl hover:bg-gray-50 transition-all shadow-md border border-gray-200 flex items-center justify-center gap-3 hover:shadow-lg">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6" alt="Google logo">
                        Iniciar Sesión con Google
                    </button>
                </div>
                <div id="login-error" class="text-red-500 mt-4 text-sm hidden bg-red-50 p-2 rounded"></div>
                <p class="mt-8 text-xs text-gray-400 border-t pt-4">Los profesores deben acceder escaneando el código QR de la reunión.</p>
            </div>
        </div>

        <!-- Vista del Administrador -->
        <div id="admin-view" class="hidden">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 bg-white p-4 rounded-xl shadow-sm">
                <h1 class="text-2xl font-bold text-indigo-600 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>
                    Panel de Dirección
                </h1>
                <div class="flex flex-wrap items-center gap-2 justify-center">
                    <span id="admin-email-display" class="text-xs font-mono text-gray-500 hidden lg:inline bg-gray-100 px-2 py-1 rounded"></span>
                    
                    <button onclick="resetTestData()" class="p-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors" title="Resetear Pruebas">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </button>

                    <button onclick="openTeacherManagement()" class="bg-indigo-50 text-indigo-700 px-4 py-2 rounded-lg hover:bg-indigo-100 text-sm font-semibold transition-colors flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                        Claustro
                    </button>

                    <button onclick="logout()" class="text-gray-500 hover:text-red-600 px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors" title="Salir">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                    </button>
                </div>
            </div>
            
            <!-- Crear Sesión -->
            <div class="bg-white p-6 rounded-2xl shadow-md border-l-4 border-indigo-500 transition-shadow hover:shadow-lg">
                <h2 class="text-lg font-bold mb-4 text-gray-800">Nueva Reunión</h2>
                <div class="flex gap-4">
                    <input type="text" id="meeting-name" placeholder="Nombre de la reunión (Ej: Claustro Final Curso)" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none transition-all">
                    <button onclick="createMeeting()" class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition-colors shadow-md">Crear</button>
                </div>
            </div>
            
            <!-- Sesiones Creadas -->
            <div class="bg-white p-6 rounded-2xl shadow-md mt-6">
                <h2 class="text-lg font-bold mb-4 text-gray-800 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    Reuniones Activas e Histórico
                </h2>
                <div id="meetings-list" class="space-y-4"></div>
            </div>

            <!-- Informes -->
            <div class="bg-white p-6 rounded-2xl shadow-md mt-6">
                <h2 class="text-lg font-bold mb-4 text-gray-800 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                    Informes de Asistencia
                </h2>
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button onclick="showTab('individual-report')" id="tab-individual-report" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-600 transition-colors">Informe por Profesor(es)</button>
                        <button onclick="showTab('general-report')" id="tab-general-report" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 transition-colors">Informe General</button>
                    </nav>
                </div>

                <!-- Contenido Informes -->
                <div id="individual-report-content" class="mt-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div class="md:col-span-1">
                            <label for="teacher-select" class="block text-sm font-medium text-gray-700 mb-1">Profesor(es)</label>
                            <select id="teacher-select" multiple class="mt-1 block w-full p-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 h-32 text-sm"></select>
                            <div class="flex justify-between mt-1">
                                <span class="text-xs text-gray-400">Ctrl/Cmd + Clic para varios</span>
                                <button onclick="selectAllTeachers(true)" class="text-xs text-indigo-600 hover:underline font-medium">Seleccionar Todos</button>
                            </div>
                        </div>
                        <div class="md:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-4">
                             <div><label class="block text-sm font-medium text-gray-700 mb-1">Desde</label><input type="date" id="start-date" class="block w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"></div>
                             <div><label class="block text-sm font-medium text-gray-700 mb-1">Hasta</label><input type="date" id="end-date" class="block w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"></div>
                             <button onclick="getTeacherAttendance()" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 self-end shadow-md transition-colors">Consultar</button>
                        </div>
                    </div>
                    <div id="teacher-attendance-results" class="mt-6"></div>
                </div>

                <div id="general-report-content" class="hidden mt-6">
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                         <div><label class="block text-sm font-medium text-gray-700 mb-1">Desde</label><input type="date" id="general-start-date" class="block w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"></div>
                         <div><label class="block text-sm font-medium text-gray-700 mb-1">Hasta</label><input type="date" id="general-end-date" class="block w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"></div>
                         <button onclick="getGeneralAttendance()" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 self-end shadow-md transition-colors">Generar Informe</button>
                    </div>
                    <div id="general-attendance-results" class="mt-6"></div>
                </div>
            </div>
        </div>

        <!-- Vista del Profesor -->
        <div id="teacher-view" class="hidden">
            <div id="teacher-status-message" class="bg-white p-8 rounded-2xl shadow-lg text-center mt-10 border-t-4 border-indigo-500"></div>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal fixed w-full h-full top-0 left-0 flex items-center justify-center hidden z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-60 backdrop-blur-sm" onclick="closeModal()"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-2xl mx-auto rounded-2xl shadow-2xl z-50 overflow-y-auto transform transition-all scale-100">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3 border-b mb-4">
                    <p id="modal-title" class="text-2xl font-bold text-gray-800"></p>
                    <div class="modal-close cursor-pointer z-50 p-2 hover:bg-gray-100 rounded-full transition-colors" onclick="closeModal()">
                        <svg class="fill-current text-black" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18"><path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path></svg>
                    </div>
                </div>
                <div id="modal-body" class="my-2"></div>
            </div>
        </div>
    </div>

    <!-- Datalist global para el autocompletado de profesores (Admin y Profesor) -->
    <datalist id="teacher-list-admin"></datalist>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, getDoc, deleteDoc, getDocs, collection, onSnapshot, query, where, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // *******************************************************************
        // CONFIGURACIÓN DE FIREBASE
        const firebaseConfig = {
          apiKey: "AIzaSyCu7P0nV5vSeqvwLtfUpHIpnAgGu9Dx3mY",
          authDomain: "control-asistencia-pruebas.firebaseapp.com",
          projectId: "control-asistencia-pruebas",
          storageBucket: "control-asistencia-pruebas.firebasestorage.app",
          messagingSenderId: "429481399686",
          appId: "1:429481399686:web:955659d3e70826b22a0807",
          measurementId: "G-104TMJF8R4"
        };
        // *******************************************************************

        // --- EMAILS AUTORIZADOS ---
        const AUTHORIZED_EMAILS = [
            "donraulvp@gmail.com", 
            "director@colegio.com" 
        ];

        let app, auth, db, userId;
        let qrInterval;
        let generalReportDataForExport = null;
        let allTeachersList = []; 
        let currentMeetingDataForPrint = null; 
        
        // Función para mostrar notificaciones (Toasts)
        window.showToast = (message, type = 'info') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            // Iconos según tipo
            let icon = '';
            if(type === 'success') icon = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
            if(type === 'error') icon = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
            
            toast.innerHTML = `<div class="flex items-center gap-2">${icon}<span>${message}</span></div>`;
            container.appendChild(toast);

            // Eliminar después de 3 segundos
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.5s ease-out forwards';
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        };

        document.addEventListener('DOMContentLoaded', () => {
             // Establecer fechas por defecto en inputs
             const today = new Date().toISOString().split('T')[0];
             const firstDay = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
             
             ['start-date', 'general-start-date'].forEach(id => {
                 const el = document.getElementById(id);
                 if(el) el.value = firstDay;
             });
             ['end-date', 'general-end-date'].forEach(id => {
                 const el = document.getElementById(id);
                 if(el) el.value = today;
             });

             if (!firebaseConfig.apiKey || firebaseConfig.apiKey.includes("API_KEY")) {
                document.getElementById('loading-screen').innerHTML = `<div class="bg-white p-8 rounded-lg shadow-xl text-center"><h2 class="text-2xl font-bold text-red-600">Error de Configuración</h2><p class="mt-4 text-gray-700">La configuración de Firebase no es correcta.</p></div>`;
                return;
             }

            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            onAuthStateChanged(auth, async (user) => {
                const params = new URLSearchParams(window.location.search);
                const isTeacherLink = params.has('meeting');

                if (user) {
                    userId = user.uid;
                    if (user.isAnonymous) {
                        initializeAppState(); 
                    } else {
                        if (AUTHORIZED_EMAILS.length > 0 && !AUTHORIZED_EMAILS.includes(user.email)) {
                            await signOut(auth);
                            showToast("Acceso denegado: Email no autorizado.", 'error');
                            showView('role-selection-view');
                            document.getElementById('loading-screen').style.display = 'none';
                            return;
                        }
                        
                        document.getElementById('admin-email-display').textContent = user.email;
                        initializeAppState(); 
                    }
                } else {
                    if (isTeacherLink) {
                        try {
                            await signInAnonymously(auth);
                        } catch (error) {
                            console.error("Auth Error:", error);
                            document.getElementById('loading-screen').innerHTML = `Error de conexión.`;
                        }
                    } else {
                        document.getElementById('loading-screen').style.display = 'none';
                        showView('role-selection-view');
                    }
                }
            });
        });
        
        window.loginWithGoogle = async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Login failed", error);
                const errorDiv = document.getElementById('login-error');
                errorDiv.textContent = "Error al iniciar sesión: " + error.message;
                errorDiv.classList.remove('hidden');
                if (error.code === 'auth/unauthorized-domain') {
                    alert("Este dominio no está autorizado en Firebase. Añádelo en la consola de Firebase > Authentication > Settings.");
                }
            }
        };

        window.logout = async () => {
            await signOut(auth);
            window.location.reload();
        };

        window.resetTestData = async () => {
            if(!confirm("⚠️ ¡ATENCIÓN! ⚠️\n\n¿Estás seguro de que quieres BORRAR TODOS LOS DATOS?\n\nSe eliminarán todas las reuniones, profesores y registros de asistencia. Esta acción no se puede deshacer.")) return;
            if(!confirm("Confirmación final: ¿Realmente quieres eliminar toda la base de datos de pruebas?")) return;

            const loading = document.getElementById('loading-screen');
            loading.style.display = 'flex';
            loading.innerHTML = '<div class="text-white text-center"><div class="lds-dual-ring"></div><p class="mt-4">Borrando datos, por favor espera...</p></div>';

            try {
                const meetingsSnap = await getDocs(collection(db, 'meetings'));
                for(const mDoc of meetingsSnap.docs) {
                    const attendeesSnap = await getDocs(collection(db, `meetings/${mDoc.id}/attendees`));
                    for(const aDoc of attendeesSnap.docs) await deleteDoc(aDoc.ref);
                    const tokensSnap = await getDocs(collection(db, `meetings/${mDoc.id}/validTokens`));
                    for(const tDoc of tokensSnap.docs) await deleteDoc(tDoc.ref);
                    await deleteDoc(mDoc.ref);
                }

                const teachersSnap = await getDocs(collection(db, 'teachers'));
                for(const tDoc of teachersSnap.docs) {
                    const attSnap = await getDocs(collection(db, `teachers/${tDoc.id}/attendedMeetings`));
                    for(const amDoc of attSnap.docs) await deleteDoc(amDoc.ref);
                    await deleteDoc(tDoc.ref);
                }

                showToast("Datos eliminados correctamente.", 'success');
                setTimeout(() => window.location.reload(), 1500);

            } catch (error) {
                console.error("Error al resetear:", error);
                showToast("Error al borrar los datos.", 'error');
                loading.style.display = 'none';
            }
        }

        function initializeAppState() {
            document.getElementById('loading-screen').style.display = 'none';
            setupUIFromURL();
        }

        function setupUIFromURL() {
            const params = new URLSearchParams(window.location.search);
            if (params.has('meeting') && params.has('token')) {
                validateTokenAndShowTeacherView(params.get('meeting'), params.get('token'));
            } else {
                if (auth.currentUser && !auth.currentUser.isAnonymous) {
                    showView('admin-view');
                    listenForMeetings();
                    listenForTeachers();
                } else {
                    if (auth.currentUser?.isAnonymous) {
                        showView('role-selection-view');
                    } else {
                        showView('role-selection-view');
                    }
                }
            }
        }
        
        window.showView = (viewId) => {
            ['role-selection-view', 'admin-view', 'teacher-view'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
        };

        window.showTab = (tabId) => {
            const tabs = ['individual-report', 'general-report'];
            tabs.forEach(id => {
                document.getElementById(`${id}-content`).classList.add('hidden');
                document.getElementById(`tab-${id}`).classList.remove('border-indigo-500', 'text-indigo-600');
                document.getElementById(`tab-${id}`).classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            });
            document.getElementById(`${tabId}-content`).classList.remove('hidden');
            document.getElementById(`tab-${tabId}`).classList.add('border-indigo-500', 'text-indigo-600');
            document.getElementById(`tab-${tabId}`).classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
        }

        async function validateTokenAndShowTeacherView(meetingId, tokenId) {
            showView('teacher-view');
            const statusDiv = document.getElementById('teacher-status-message');
            statusDiv.innerHTML = '<div class="lds-dual-ring" style="border-color: #4f46e5 transparent #4f46e5 transparent;"></div><p class="mt-4">Validando código QR...</p>';

            const tokenRef = doc(db, `meetings/${meetingId}/validTokens/${tokenId}`);
            const tokenSnap = await getDoc(tokenRef);

            if (tokenSnap.exists() && tokenSnap.data().expiresAt.toMillis() > Date.now()) {
                await deleteDoc(tokenRef);
                const meetingRef = doc(db, `meetings/${meetingId}`);
                const meetingSnap = await getDoc(meetingRef);
                const meetingName = meetingSnap.exists() ? meetingSnap.data().name : 'Reunión desconocida';
                const savedName = localStorage.getItem('teacherName');
                
                let teachersDatalist = '';
                if (!savedName) {
                    try {
                        const teachersSnap = await getDocs(collection(db, 'teachers'));
                        const teacherNames = teachersSnap.docs.map(d => d.data().name).sort();
                        teachersDatalist = `<datalist id="teacher-suggestions">${teacherNames.map(n => `<option value="${n}">`).join('')}</datalist>`;
                    } catch(e) { }
                }

                if (savedName) {
                    statusDiv.innerHTML = `
                        <img src="https://web.virgendelpasico.net/wp-content/uploads/2024/01/cropped-ncoop-scaled-1-300x253.jpg" alt="Logo Virgen del Pasico" class="app-logo">
                        <p class="text-xl font-semibold mb-4 text-gray-700">Asistencia para: "${meetingName}"</p>
                        <p class="text-2xl text-gray-800 mb-2">¿Eres <strong class="font-bold">${savedName}</strong>?</p>
                        <p class="text-gray-500 mb-6">Confirma para registrar tu asistencia.</p>
                        <button id="confirm-btn" onclick="recordAttendance('${meetingId}', true, this)" class="w-full max-w-md mx-auto bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition-colors text-lg">Sí, confirmar asistencia</button>
                        <button onclick="showChangeTeacherForm('${meetingId}', '${meetingName}')" class="mt-4 text-sm text-indigo-600 hover:underline">No soy yo / Cambiar nombre</button>
                    `;
                } else {
                    showChangeTeacherForm(meetingId, meetingName, teachersDatalist);
                }
            } else {
                statusDiv.innerHTML = '<p class="text-red-500 font-bold text-xl">Código QR caducado o inválido. Por favor, escanea el código actual en la pantalla.</p>';
            }
        }

        window.showChangeTeacherForm = async (meetingId, meetingName, preloadedDatalist = '') => {
             if (!preloadedDatalist) {
                 try {
                    const teachersSnap = await getDocs(collection(db, 'teachers'));
                    const teacherNames = teachersSnap.docs.map(d => d.data().name).sort();
                    preloadedDatalist = `<datalist id="teacher-suggestions">${teacherNames.map(n => `<option value="${n}">`).join('')}</datalist>`;
                 } catch(e) {}
             }

             document.getElementById('teacher-status-message').innerHTML = `
                <img src="https://web.virgendelpasico.net/wp-content/uploads/2024/01/cropped-ncoop-scaled-1-300x253.jpg" alt="Logo Virgen del Pasico" class="app-logo">
                <p class="text-xl font-semibold mb-4 text-gray-700">Asistencia para: "${meetingName}"</p>
                <p class="text-gray-600 mb-6">Introduce tu nombre completo:</p>
                <input type="text" id="teacher-name-input" list="teacher-suggestions" placeholder="Empieza a escribir tu nombre..." class="w-full max-w-md mx-auto p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none mb-6">
                ${preloadedDatalist}
                <button id="confirm-new-btn" onclick="recordAttendance('${meetingId}', false, this)" class="w-full max-w-md mx-auto bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition-colors text-lg">Confirmar Asistencia</button>
            `;
            const input = document.getElementById('teacher-name-input');
            input.value = localStorage.getItem('teacherName') || '';
            input.focus();
        }

        window.recordAttendance = async (meetingId, isRecognized, buttonEl) => {
            const originalButtonText = buttonEl.innerHTML;
            buttonEl.disabled = true;
            buttonEl.innerHTML = `<span class="animate-pulse">Registrando...</span>`;

            let name;
            if (isRecognized) {
                name = localStorage.getItem('teacherName');
            } else {
                const nameInput = document.getElementById('teacher-name-input');
                name = nameInput.value.trim();
                if (!name) {
                    nameInput.classList.add('border-red-500');
                    setTimeout(() => nameInput.classList.remove('border-red-500'), 2000);
                    buttonEl.disabled = false;
                    buttonEl.innerHTML = originalButtonText;
                    return;
                }
            }

            let teacherId = localStorage.getItem('teacherId');
            
            if (!teacherId || !isRecognized) {
                const teachersCol = collection(db, `teachers`);
                const q = query(teachersCol, where("name", "==", name));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    const newTeacherRef = await addDoc(teachersCol, { name: name });
                    teacherId = newTeacherRef.id;
                } else {
                    teacherId = querySnapshot.docs[0].id;
                }
            }

            const meetingRef = doc(db, `meetings/${meetingId}`);
            const meetingSnap = await getDoc(meetingRef);
            if (!meetingSnap.exists()) {
                 buttonEl.disabled = false;
                 buttonEl.innerHTML = "Error: Reunión no encontrada";
                 return;
            }
            const meetingData = meetingSnap.data();

            try {
                const existingAttendanceQuery = query(collection(db, `meetings/${meetingId}/attendees`), where("teacherId", "==", teacherId));
                const existingSnapshot = await getDocs(existingAttendanceQuery);

                if (!existingSnapshot.empty) {
                    document.getElementById('teacher-status-message').innerHTML = `
                        <div class="text-yellow-500 mb-4"><svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg></div>
                        <h2 class="text-2xl font-bold mb-2 text-gray-800">Ya registrado</h2>
                        <p class="text-gray-600">Ya constas en la lista de "${meetingData.name}".</p>
                    `;
                    return;
                }

                await addDoc(collection(db, `meetings/${meetingId}/attendees`), { name, teacherId, timestamp: serverTimestamp() });
                await setDoc(doc(db, `teachers/${teacherId}/attendedMeetings/${meetingId}`), { meetingName: meetingData.name, meetingDate: meetingData.createdAt });
                localStorage.setItem('teacherName', name);
                localStorage.setItem('teacherId', teacherId);
                
                document.getElementById('teacher-status-message').innerHTML = `
                    <svg class="mx-auto h-16 w-16 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <h2 class="text-2xl font-bold mt-4">¡Asistencia Registrada!</h2>
                    <p class="text-gray-600 mt-2">Gracias por confirmar tu asistencia a "${meetingData.name}".</p>`;
            } catch (error) { 
                console.error("Registro fallido", error); 
                buttonEl.disabled = false; 
                buttonEl.innerHTML = originalButtonText;
            }
        };

        const QR_LIFESPAN_MS = 30000;
        window.showQrCode = (meetingId, meetingName) => {
            document.getElementById('modal-title').textContent = `QR para: ${meetingName}`;
            const modalBody = document.getElementById('modal-body');
            modalBody.innerHTML = `
                <img src="https://web.virgendelpasico.net/wp-content/uploads/2024/01/cropped-ncoop-scaled-1-300x253.jpg" alt="Logo" class="app-logo">
                <p class="text-center text-gray-600 mb-4">Escanea para firmar. Se actualiza cada ${QR_LIFESPAN_MS / 1000}s.</p>
                <div class="flex justify-center gap-2 mb-4">
                    <button onclick="copyInviteLink('${meetingId}')" class="bg-blue-100 text-blue-700 text-xs font-bold py-1 px-3 rounded hover:bg-blue-200 flex items-center gap-1 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>
                        Copiar Enlace (Validez 24h)
                    </button>
                </div>
                <div id="qrcode-container" class="flex justify-center p-4 bg-white border rounded-lg relative">
                    <div id="qrcode"></div>
                    <p id="qr-expired-text" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-90 text-red-500 font-bold hidden">CADUCADO</p>
                </div>
                <div class="mt-2 h-1 bg-gray-200 rounded-full overflow-hidden"><div id="qr-timer-bar"></div></div>`;
            openModal();

            const generateAndDisplayDynamicQR = async () => {
                const expiredText = document.getElementById('qr-expired-text');
                if (expiredText) expiredText.classList.remove('hidden');
                
                const tokenId = crypto.randomUUID();
                const expiresAt = Timestamp.fromMillis(Date.now() + QR_LIFESPAN_MS);
                await setDoc(doc(db, `meetings/${meetingId}/validTokens`, tokenId), { expiresAt });
                
                const url = `${window.location.href.split('?')[0]}?meeting=${meetingId}&token=${tokenId}`;
                const qrContainer = document.getElementById('qrcode');
                if(qrContainer) {
                    qrContainer.innerHTML = '';
                    new QRCode(qrContainer, { text: url, width: 256, height: 256 });
                }
                 if (expiredText) expiredText.classList.add('hidden');
                 const timerBar = document.getElementById('qr-timer-bar');
                 if(timerBar) {
                    timerBar.style.transition = 'none';
                    timerBar.style.width = '100%';
                    timerBar.offsetHeight; 
                    timerBar.style.transition = `width ${QR_LIFESPAN_MS / 1000}s linear`;
                    timerBar.style.width = '0%';
                 }
            };
            generateAndDisplayDynamicQR();
            qrInterval = setInterval(generateAndDisplayDynamicQR, QR_LIFESPAN_MS);
        };

        window.copyInviteLink = async (meetingId) => {
            const tokenId = crypto.randomUUID();
            // Token válido por 24 horas (24 * 60 * 60 * 1000 ms)
            const expiresAt = Timestamp.fromMillis(Date.now() + 86400000);
            
            try {
                await setDoc(doc(db, `meetings/${meetingId}/validTokens`, tokenId), { expiresAt });
                const url = `${window.location.href.split('?')[0]}?meeting=${meetingId}&token=${tokenId}`;
                
                await navigator.clipboard.writeText(url);
                showToast("Enlace de invitación copiado (Válido 24h)", "success");
            } catch(e) {
                console.error("Error generating link", e);
                showToast("Error al generar el enlace", "error");
            }
        };

        window.closeModal = () => {
            clearInterval(qrInterval);
            document.getElementById('modal').classList.add('hidden');
            document.body.classList.remove('modal-active');
        };

        window.createMeeting = async () => {
            const name = document.getElementById('meeting-name').value.trim();
            if (!name) return;
            try {
                await addDoc(collection(db, `meetings`), { name, createdAt: serverTimestamp(), createdBy: userId });
                document.getElementById('meeting-name').value = '';
                showToast("Sesión creada correctamente", "success");
            } catch (error) { 
                console.error("Error creating meeting: ", error);
                showToast("Error al crear la sesión", "error");
            }
        };
        
        window.deleteMeeting = async (meetingId) => {
            if(!confirm("¿Borrar esta sesión? Se perderá el acceso a la lista desde aquí.")) return;
            try { 
                await deleteDoc(doc(db, `meetings/${meetingId}`));
                showToast("Sesión borrada", "info");
            } catch (error) { 
                alert("Error al borrar"); 
            }
        }

        window.openTeacherManagement = () => {
            document.getElementById('modal-title').textContent = "Gestión del Claustro";
            document.getElementById('modal-body').innerHTML = `
                <div class="p-1">
                    <p class="text-sm text-gray-600 mb-4">Pega aquí la lista de profesores (uno por línea) para precargarla en el sistema. Esto ayudará a que el nombre salga sugerido al registrarse.</p>
                    <div class="flex flex-col gap-2">
                        <textarea id="bulk-teachers" rows="10" placeholder="Ejemplo:\nJuan Pérez García\nMaría López Martínez..." class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none w-full text-sm"></textarea>
                        <button onclick="importTeachers(this)" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors self-end text-sm">Importar Lista</button>
                    </div>
                </div>
            `;
            openModal();
        };

        function listenForMeetings() {
            onSnapshot(query(collection(db, `meetings`)), (snapshot) => {
                const list = document.getElementById('meetings-list');
                const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => b.createdAt?.toMillis() - a.createdAt?.toMillis());
                list.innerHTML = data.map(m => `
                    <div class="flex flex-col md:flex-row justify-between items-center p-4 border rounded-lg bg-gray-50 hover:bg-white hover:shadow-sm transition-all">
                        <div class="mb-2 md:mb-0"><p class="font-bold text-indigo-700">${m.name}</p><p class="text-xs text-gray-500">${m.createdAt ? new Date(m.createdAt.toDate()).toLocaleString('es-ES') : ''}</p></div>
                        <div class="flex gap-2">
                            <button onclick="showQrCode('${m.id}', '${m.name}')" class="bg-indigo-100 text-indigo-700 text-sm font-bold py-2 px-3 rounded hover:bg-indigo-200 transition-colors">QR</button>
                            <button onclick="viewAttendance('${m.id}', '${m.name}')" class="bg-blue-100 text-blue-700 text-sm font-bold py-2 px-3 rounded hover:bg-blue-200 transition-colors">Lista</button>
                            <button onclick="deleteMeeting('${m.id}')" class="text-red-400 hover:text-red-600 p-2"><svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                        </div>
                    </div>`).join('');
            });
        }
        
        function listenForTeachers() {
            onSnapshot(query(collection(db, `teachers`)), (snapshot) => {
                const teachers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => a.name.localeCompare(b.name));
                allTeachersList = teachers;
                
                // Actualizar datalist global
                document.getElementById('teacher-list-admin').innerHTML = teachers.map(t => `<option value="${t.name}">`).join('');
                
                // Actualizar multiselect de informes
                document.getElementById('teacher-select').innerHTML = teachers.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            });
        }
        
        window.importTeachers = async (btn) => {
            const textarea = document.getElementById('bulk-teachers');
            const text = textarea.value.trim();
            if(!text) return alert("Pega una lista de nombres");
            
            const names = text.split('\n').map(n => n.trim()).filter(n => n.length > 0);
            if(names.length === 0) return alert("No hay nombres válidos");
            
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = "Importando...";
            
            try {
                const existingSnap = await getDocs(collection(db, 'teachers'));
                const existingNames = new Set(existingSnap.docs.map(d => d.data().name.toLowerCase()));
                
                let added = 0;
                for(const name of names) {
                    if(!existingNames.has(name.toLowerCase())) {
                        await addDoc(collection(db, 'teachers'), {name});
                        added++;
                    }
                }
                showToast(`Importación: ${added} profesores añadidos.`, "success");
                textarea.value = "";
                closeModal(); 
            } catch(e) {
                console.error(e);
                showToast("Error durante la importación", "error");
            }
            btn.disabled = false;
            btn.innerHTML = originalText;
        };
        
        window.selectAllTeachers = (val) => {
            const opts = document.getElementById('teacher-select').options;
            for(let i=0; i<opts.length; i++) opts[i].selected = val;
        }

        window.getTeacherAttendance = async () => {
            const selectedIds = Array.from(document.getElementById('teacher-select').selectedOptions).map(o => o.value);
            const start = document.getElementById('start-date').value;
            const end = document.getElementById('end-date').value;
            const resDiv = document.getElementById('teacher-attendance-results');
            
            if (selectedIds.length === 0) { resDiv.innerHTML = '<p class="text-red-500">Selecciona profesor(es).</p>'; return; }
            resDiv.innerHTML = '<p>Buscando...</p>';
            
            let allData = [];
            for (const tid of selectedIds) {
                const tName = document.getElementById('teacher-select').querySelector(`option[value="${tid}"]`).text;
                let q = query(collection(db, `teachers/${tid}/attendedMeetings`));
                if (start) q = query(q, where("meetingDate", ">=", Timestamp.fromDate(new Date(start))));
                if (end) { const e = new Date(end); e.setHours(23,59,59); q = query(q, where("meetingDate", "<=", Timestamp.fromDate(e))); }
                const snap = await getDocs(q);
                allData.push(...snap.docs.map(d => ({...d.data(), teacherName: tName})));
            }
            
            if (allData.length === 0) { resDiv.innerHTML = '<p class="text-gray-500">Sin resultados.</p>'; return; }
            
            const grouped = allData.reduce((acc, i) => { (acc[i.teacherName] = acc[i.teacherName] || []).push(i); return acc; }, {});
            let html = '';
            for(const name in grouped) {
                html += `<div class="mb-4 bg-gray-50 p-3 rounded shadow-sm border"><h4 class="font-bold text-indigo-700">${name} (${grouped[name].length})</h4><ul class="text-sm text-gray-600 pl-4 list-disc">${grouped[name].map(i => `<li>${i.meetingName} <span class="text-xs text-gray-400">(${new Date(i.meetingDate.toDate()).toLocaleDateString()})</span></li>`).join('')}</ul></div>`;
            }
            window.teacherReportDataForExport = allData;
            html += `<button onclick="exportTeacherAttendanceToCSV()" class="w-full bg-green-500 text-white font-bold py-2 rounded mt-2 hover:bg-green-600 transition-colors">Exportar CSV</button>`;
            resDiv.innerHTML = html;
        };

        window.exportTeacherAttendanceToCSV = () => {
            const data = window.teacherReportDataForExport;
            let csv = "Profesor,Reunion,Fecha\n" + data.map(i => `"${i.teacherName}","${i.meetingName}","${new Date(i.meetingDate.seconds*1000).toLocaleString()}"`).join("\n");
            const link = document.createElement("a"); link.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv); link.download = `informe_profesores.csv`; link.click();
        };

        window.printAttendanceList = () => {
            if (!currentMeetingDataForPrint) return;
            const { name, attendees } = currentMeetingDataForPrint;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Asistencia - ${name}</title>
                    <style>
                        body { font-family: 'Inter', sans-serif; padding: 40px; color: #333; }
                        h1 { text-align: center; color: #333; font-size: 24px; margin-bottom: 5px; }
                        .subtitle { text-align: center; color: #666; font-size: 14px; margin-bottom: 30px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
                        th, td { border-bottom: 1px solid #ddd; padding: 12px 8px; text-align: left; }
                        th { background-color: #f9fafb; font-weight: bold; text-transform: uppercase; font-size: 12px; color: #6b7280; }
                        tr:nth-child(even) { background-color: #f9fafb; }
                        .footer { margin-top: 30px; border-top: 2px solid #333; padding-top: 10px; display: flex; justify-content: space-between; font-weight: bold; }
                        .logo { display: block; margin: 0 auto 20px; height: 80px; width: auto; }
                        @media print {
                            body { -webkit-print-color-adjust: exact; }
                        }
                    </style>
                </head>
                <body>
                    <img src="https://web.virgendelpasico.net/wp-content/uploads/2024/01/cropped-ncoop-scaled-1-300x253.jpg" class="logo" alt="Logo">
                    <h1>Lista de Asistencia</h1>
                    <div class="subtitle">Evento: <strong>${name}</strong> &bull; Fecha de impresión: ${new Date().toLocaleDateString()}</div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Nombre del Profesor</th>
                                <th style="text-align:right">Hora de Registro</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${attendees.map((a, index) => `
                                <tr>
                                    <td style="width: 30px; color: #999;">${index + 1}</td>
                                    <td>${a.name}</td>
                                    <td style="text-align:right">${a.timestamp ? new Date(a.timestamp.seconds * 1000).toLocaleTimeString('es-ES') : '--:--'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <span>Firma / Sello del Centro:</span>
                        <span>Total Asistentes: ${attendees.length}</span>
                    </div>
                    
                    <script>
                        window.onload = function() { 
                            window.print(); 
                        }
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        };

        window.viewAttendance = (mId, mName) => {
            document.getElementById('modal-title').textContent = mName;
            
            // Inyectar HTML para añadir manualmente
            document.getElementById('modal-body').innerHTML = `
                <div class="flex justify-end mb-4">
                     <button onclick="printAttendanceList()" id="btn-print-list" disabled class="flex items-center gap-2 text-sm bg-white text-gray-700 hover:text-gray-900 border border-gray-300 hover:bg-gray-50 py-2 px-4 rounded-lg shadow-sm transition-colors opacity-50 cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                        </svg>
                        Imprimir Lista
                     </button>
                </div>
                
                <div class="bg-indigo-50 p-3 rounded-lg mb-4 text-sm">
                    <p class="text-xs font-semibold mb-2 text-indigo-700">Añadir asistente manualmente:</p>
                    <div class="flex gap-2">
                         <input type="text" id="manual-teacher-name" list="teacher-list-admin" placeholder="Escribe el nombre..." class="flex-grow p-2 border rounded-md text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                         <button onclick="manualRecordAttendance('${mId}')" class="bg-indigo-600 text-white text-xs font-bold py-2 px-4 rounded-md hover:bg-indigo-700 transition-colors">Añadir</button>
                    </div>
                </div>
                <div id="attendance-list-container">Cargando...</div>`;
            openModal();
            
            onSnapshot(query(collection(db, `meetings/${mId}/attendees`)), (snap) => {
                const list = document.getElementById('attendance-list-container');
                if(!list) return;
                const data = snap.docs.map(d => d.data()).sort((a,b) => a.timestamp - b.timestamp);
                
                currentMeetingDataForPrint = { name: mName, attendees: data };
                
                const btnPrint = document.getElementById('btn-print-list');
                if(btnPrint) {
                    btnPrint.disabled = false;
                    btnPrint.classList.remove('opacity-50', 'cursor-not-allowed');
                }

                list.innerHTML = `<p class="mb-2 font-bold text-gray-700">Total: ${data.length}</p><ul class="max-h-60 overflow-y-auto border rounded-lg bg-white divide-y">${data.map(a => `<li class="flex justify-between py-2 px-3 hover:bg-gray-50"><span>${a.name}</span><span class="text-xs text-gray-400">${a.timestamp?.toDate().toLocaleTimeString()||''}</span></li>`).join('')}</ul>`;
            });
        }

        window.manualRecordAttendance = async (mId) => {
            const inp = document.getElementById('manual-teacher-name');
            const name = inp.value.trim();
            if(!name) {
                showToast("Escribe un nombre", "error");
                return;
            }
            
            let tid;
            const q = query(collection(db,'teachers'), where("name","==",name));
            const snap = await getDocs(q);
            if(snap.empty) { const ref = await addDoc(collection(db,'teachers'),{name}); tid = ref.id; }
            else tid = snap.docs[0].id;

            const mRef = await getDoc(doc(db,`meetings/${mId}`));
            const mData = mRef.data();
            try {
                // Check dup
                const existingQ = query(collection(db, `meetings/${mId}/attendees`), where("teacherId", "==", tid));
                const existingSnap = await getDocs(existingQ);
                if (!existingSnap.empty) {
                    showToast(`${name} ya está en la lista`, "info");
                    inp.value = "";
                    return;
                }

                await addDoc(collection(db,`meetings/${mId}/attendees`),{name, teacherId:tid, timestamp: serverTimestamp()});
                await setDoc(doc(db,`teachers/${tid}/attendedMeetings/${mId}`),{meetingName:mData.name, meetingDate:mData.createdAt});
                showToast("Añadido correctamente", "success");
                inp.value = "";
            } catch(e) { console.error(e); showToast("Error al añadir", "error"); }
        }

        window.getGeneralAttendance = async () => {
            const startDate = document.getElementById('general-start-date').value;
            const endDate = document.getElementById('general-end-date').value;
            const resultsDiv = document.getElementById('general-attendance-results');
            resultsDiv.innerHTML = '<p class="text-gray-500 italic">Generando informe...</p>';

            const teachersSnap = await getDocs(collection(db, 'teachers'));
            const teachers = teachersSnap.docs.map(doc => ({ id: doc.id, name: doc.data().name }));
            teachers.sort((a, b) => a.name.localeCompare(b.name));

            let meetingsQuery = query(collection(db, 'meetings'));
            if (startDate) meetingsQuery = query(meetingsQuery, where("createdAt", ">=", Timestamp.fromDate(new Date(startDate))));
            if (endDate) {
                 const endOfDay = new Date(endDate);
                 endOfDay.setHours(23, 59, 59, 999);
                 meetingsQuery = query(meetingsQuery, where("createdAt", "<=", Timestamp.fromDate(endOfDay)));
            }
            const meetingsSnap = await getDocs(meetingsQuery);
            const meetings = meetingsSnap.docs.map(doc => ({ id: doc.id, name: doc.data().name, date: doc.data().createdAt.toDate() }));
            meetings.sort((a, b) => a.date - b.date);

            const attendancePromises = teachers.map(async (teacher) => {
                const attendedMeetingsSnap = await getDocs(collection(db, `teachers/${teacher.id}/attendedMeetings`));
                const attendedMeetingIds = new Set(attendedMeetingsSnap.docs.map(doc => doc.id));
                return { ...teacher, attendedMeetingIds };
            });

            const fullReportData = await Promise.all(attendancePromises);

            generalReportDataForExport = {report: fullReportData, meetings: meetings.map(m => ({...m, date: m.date.toISOString()})) };

            let summaryHtml = `
            <div class="flex gap-2 mb-4">
                <button onclick="exportGeneralAttendanceToCSV()" class="flex-1 bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 shadow-sm transition-colors">Exportar CSV</button>
                <button onclick="printGeneralReport()" class="flex-1 bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 shadow-sm transition-colors flex justify-center items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                    </svg>
                    Imprimir / PDF
                </button>
            </div>
            `;

            summaryHtml += '<div class="overflow-x-auto border rounded-lg"><table class="min-w-full text-xs text-left bg-white">';
            summaryHtml += '<thead class="bg-gray-50"><tr><th class="border-b p-3 font-semibold text-gray-600">Profesor</th>';
            meetings.forEach(m => {
                summaryHtml += `<th class="border-b p-3 font-normal text-center min-w-[80px]"><div class="text-xs">${m.name}<br><span class="text-gray-400 text-[10px]">${m.date.toLocaleDateString()}</span></div></th>`;
            });
            summaryHtml += '<th class="border-b p-3 font-bold text-center bg-gray-100">Total</th></tr></thead><tbody>';
            
            fullReportData.forEach((teacherData, idx) => {
                const attendedCount = [...teacherData.attendedMeetingIds].filter(id => meetings.some(m => m.id === id)).length;
                const rowClass = idx % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                summaryHtml += `<tr class="${rowClass}"><td class="border-b p-2 font-medium border-r">${teacherData.name}</td>`;
                meetings.forEach(meeting => {
                    if(teacherData.attendedMeetingIds.has(meeting.id)) {
                        summaryHtml += '<td class="border-b p-2 text-center text-green-600 font-bold border-r bg-green-50">✓</td>';
                    } else {
                        summaryHtml += '<td class="border-b p-2 border-r"></td>';
                    }
                });
                summaryHtml += `<td class="border-b p-2 text-center font-bold bg-gray-100">${attendedCount}</td></tr>`;
            });
            summaryHtml += '</tbody></table></div>';

            resultsDiv.innerHTML = summaryHtml;
        };
        
        window.printGeneralReport = () => {
            if (!generalReportDataForExport) return;
            const { report, meetings } = generalReportDataForExport;
            const start = document.getElementById('general-start-date').value;
            const end = document.getElementById('general-end-date').value;
            const dateRange = start && end ? `Desde ${new Date(start).toLocaleDateString()} hasta ${new Date(end).toLocaleDateString()}` : 'Informe Completo';

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Informe General de Asistencia</title>
                    <style>
                        body { font-family: 'Inter', sans-serif; padding: 20px; color: #333; }
                        .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 20px; }
                        .logo { height: 60px; margin-bottom: 10px; }
                        h1 { font-size: 24px; margin: 0; color: #1f2937; }
                        .subtitle { font-size: 14px; color: #6b7280; margin-top: 5px; }
                        table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 20px; }
                        th, td { border: 1px solid #e5e7eb; padding: 6px; text-align: center; }
                        th.name-col { text-align: left; width: 200px; background-color: #f9fafb; font-weight: bold; }
                        td.name-col { text-align: left; font-weight: 600; }
                        th.meeting-header { background-color: #f9fafb; font-weight: normal; vertical-align: bottom; height: 80px; }
                        .meeting-date { display: block; font-size: 9px; color: #9ca3af; margin-top: 4px; }
                        .attended { background-color: #d1fae5; color: #065f46; font-weight: bold; font-size: 14px; }
                        .total-col { background-color: #f3f4f6; font-weight: bold; }
                        .footer { margin-top: 40px; border-top: 1px solid #333; padding-top: 10px; font-size: 10px; display: flex; justify-content: space-between; }
                        tr:nth-child(even) { background-color: #f9fafb; }
                        @media print {
                            @page { size: landscape; margin: 1cm; }
                            body { -webkit-print-color-adjust: exact; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <img src="https://web.virgendelpasico.net/wp-content/uploads/2024/01/cropped-ncoop-scaled-1-300x253.jpg" class="logo" alt="Logo">
                        <h1>Informe General de Asistencia</h1>
                        <div class="subtitle">${dateRange}</div>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th class="name-col">Profesor</th>
                                ${meetings.map(m => `<th class="meeting-header">${m.name}<span class="meeting-date">${new Date(m.date).toLocaleDateString()}</span></th>`).join('')}
                                <th class="total-col">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${report.map(t => {
                                let count = 0;
                                const row = `<tr>
                                    <td class="name-col">${t.name}</td>
                                    ${meetings.map(m => {
                                        if (t.attendedMeetingIds.has(m.id)) {
                                            count++;
                                            return '<td class="attended">✓</td>';
                                        } else {
                                            return '<td></td>';
                                        }
                                    }).join('')}
                                    <td class="total-col">${count}</td>
                                </tr>`;
                                return row;
                            }).join('')}
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <span>Firma de Dirección:</span>
                        <span>Fecha de emisión: ${new Date().toLocaleDateString()}</span>
                    </div>
                    
                    <script>
                        window.onload = function() { window.print(); }
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        window.exportGeneralAttendanceToCSV = () => {
            if (!generalReportDataForExport) {
                console.error("No hay datos para exportar.");
                return;
            }
            const { report, meetings } = generalReportDataForExport;
            
            let csvContent = "Profesor,";
            meetings.forEach(meeting => {
                csvContent += `"${meeting.name} (${new Date(meeting.date).toLocaleDateString('es-ES')})",`;
            });
            csvContent += "Total\n";

            report.forEach(teacherData => {
                csvContent += `"${teacherData.name}",`;
                let total = 0;
                meetings.forEach(meeting => {
                    if (teacherData.attendedMeetingIds.has(meeting.id)) {
                        csvContent += "X,";
                        total++;
                    } else {
                        csvContent += ",";
                    }
                });
                csvContent += `${total}\n`;
            });

            const link = document.createElement("a");
            link.setAttribute("href", 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvContent));
            link.setAttribute("download", `informe_general_asistencia.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        function openModal() { document.getElementById('modal').classList.remove('hidden'); document.body.classList.add('modal-active'); }
        window.closeModal = () => { clearInterval(qrInterval); document.getElementById('modal').classList.add('hidden'); document.body.classList.remove('modal-active'); }
    </script>
</body>
</html>
