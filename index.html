<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Asistencia con QR Dinámico</title>
    <!-- Librerías externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ESTILOS CRÍTICOS: Garantizan que la app se vea bien aunque falle Tailwind */
        body { font-family: 'Inter', sans-serif; }
        
        /* Esta regla es vital: asegura que lo que debe estar oculto, se quede oculto */
        .hidden { display: none !important; }
        
        /* Asegura que el logo nunca sea gigante */
        .app-logo { max-height: 100px; width: auto; margin: 0 auto 1.5rem auto; }
        
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow: hidden; }
        
        /* Spinner de carga */
        .lds-dual-ring { display: inline-block; width: 80px; height: 80px; }
        .lds-dual-ring:after {
            content: " "; display: block; width: 64px; height: 64px; margin: 8px;
            border-radius: 50%; border: 6px solid #fff;
            border-color: #4f46e5 transparent #4f46e5 transparent;
            animation: lds-dual-ring 1.2s linear infinite;
        }
        @keyframes lds-dual-ring { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #qr-timer-bar {
            height: 4px;
            background-color: #4f46e5;
            width: 100%;
        }
        
        button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Contenedor Principal -->
    <div id="app" class="container mx-auto p-4 md:p-8 max-w-4xl">
        <div id="loading-screen" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
             <div class="lds-dual-ring"></div>
        </div>

        <!-- Vista de Acceso Dirección (Antes Selección de Rol) -->
        <div id="role-selection-view" class="hidden">
            <div class="bg-white p-8 rounded-2xl shadow-lg text-center max-w-lg mx-auto mt-10">
                <!-- LOGO DEL CENTRO -->
                <img src="https://web.virgendelpasico.net/wp-content/uploads/2024/01/cropped-ncoop-scaled-1-300x253.jpg" alt="Logo Virgen del Pasico" class="app-logo">
                
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Control de Asistencia</h1>
                <p class="text-gray-500 mb-8">Acceso exclusivo para el equipo directivo</p>
                
                <div class="flex flex-col gap-4 justify-center">
                    <button onclick="loginWithGoogle()" class="w-full bg-white text-gray-700 font-bold py-4 px-6 rounded-xl hover:bg-gray-50 transition-colors shadow-md border border-gray-300 flex items-center justify-center gap-3">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6" alt="Google logo">
                        Iniciar Sesión con Google
                    </button>
                </div>
                <div id="login-error" class="text-red-500 mt-4 text-sm hidden"></div>
                <p class="mt-8 text-xs text-gray-400">Los profesores deben acceder escaneando el código QR de la reunión.</p>
            </div>
        </div>

        <!-- Vista del Administrador -->
        <div id="admin-view" class="hidden">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <h1 class="text-2xl font-bold text-indigo-600">Panel de Dirección</h1>
                <div class="flex flex-wrap items-center gap-2 md:gap-4 justify-center">
                    <span id="admin-email-display" class="text-sm text-gray-500 hidden lg:inline"></span>
                    
                    <!-- Botón Reset (NUEVO) -->
                    <button onclick="resetTestData()" class="flex items-center gap-2 bg-red-50 text-red-700 px-3 py-2 rounded-lg border border-red-200 hover:bg-red-100 text-sm font-semibold transition-colors" title="Borrar toda la base de datos">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                        Resetear Pruebas
                    </button>

                    <!-- Botón Gestión Claustro -->
                    <button onclick="openTeacherManagement()" class="flex items-center gap-2 bg-indigo-50 text-indigo-700 px-3 py-2 rounded-lg border border-indigo-200 hover:bg-indigo-100 text-sm font-semibold transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                        Gestionar Claustro
                    </button>

                    <button onclick="logout()" class="text-gray-500 hover:text-red-600 text-sm font-medium flex items-center gap-1 border border-gray-200 px-3 py-2 rounded-lg hover:bg-gray-50">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd" />
                        </svg>
                        Salir
                    </button>
                </div>
            </div>
            
            <!-- Crear Sesión -->
            <div class="bg-white p-6 rounded-2xl shadow-lg border-l-4 border-indigo-500">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Nueva Reunión</h2>
                <div class="flex gap-4">
                    <input type="text" id="meeting-name" placeholder="Nombre de la reunión (Ej: Claustro Final Curso)" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                    <button onclick="createMeeting()" class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition-colors">Crear</button>
                </div>
            </div>
            
            <!-- Sesiones Creadas -->
            <div class="bg-white p-6 rounded-2xl shadow-lg mt-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Reuniones Activas e Histórico</h2>
                <div id="meetings-list" class="space-y-4"></div>
            </div>

            <!-- Informes -->
            <div class="bg-white p-6 rounded-2xl shadow-lg mt-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Informes de Asistencia</h2>
                
                <!-- Pestañas -->
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button onclick="showTab('individual-report')" id="tab-individual-report" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-600">
                            Informe por Profesor(es)
                        </button>
                        <button onclick="showTab('general-report')" id="tab-general-report" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                            Informe General
                        </button>
                    </nav>
                </div>

                <!-- Contenido de Pestañas -->
                <div id="individual-report-content" class="mt-6">
                    <h3 class="text-lg font-medium text-gray-800 mb-4">Consulta por Profesor(es)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div class="md:col-span-1">
                            <label for="teacher-select" class="block text-sm font-medium text-gray-700">Profesor(es)</label>
                            <select id="teacher-select" multiple class="mt-1 block w-full p-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 h-32"></select>
                            <div class="flex justify-between mt-1">
                                <span class="text-xs text-gray-500">Mantén Ctrl/Cmd para seleccionar varios.</span>
                                <button onclick="selectAllTeachers(true)" class="text-xs text-indigo-600 hover:underline">Seleccionar todos</button>
                            </div>
                        </div>
                        <div class="md:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-4">
                             <div>
                                <label for="start-date" class="block text-sm font-medium text-gray-700">Desde</label>
                                <input type="date" id="start-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                             </div>
                             <div>
                                <label for="end-date" class="block text-sm font-medium text-gray-700">Hasta</label>
                                <input type="date" id="end-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                             </div>
                             <button onclick="getTeacherAttendance()" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 self-end">Consultar</button>
                        </div>
                    </div>
                    <div id="teacher-attendance-results" class="mt-6"></div>
                </div>

                <div id="general-report-content" class="hidden mt-6">
                    <h3 class="text-lg font-medium text-gray-800 mb-4">Resumen General por Fechas</h3>
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                         <div>
                            <label for="general-start-date" class="block text-sm font-medium text-gray-700">Desde</label>
                            <input type="date" id="general-start-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                         </div>
                         <div>
                            <label for="general-end-date" class="block text-sm font-medium text-gray-700">Hasta</label>
                            <input type="date" id="general-end-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                         </div>
                         <button onclick="getGeneralAttendance()" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 self-end">Generar Informe</button>
                    </div>
                    <div id="general-attendance-results" class="mt-6"></div>
                </div>
            </div>
        </div>

        <!-- Vista del Profesor -->
        <div id="teacher-view" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <!-- Se ha eliminado el botón de volver para el profesor, ya no es necesario -->
            </div>
            <div id="teacher-status-message" class="bg-white p-8 rounded-2xl shadow-lg text-center mt-10"></div>
        </div>
    </div>

    <!-- Modal para QR y Lista de Asistencia -->
    <div id="modal" class="modal fixed w-full h-full top-0 left-0 flex items-center justify-center hidden">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50" onclick="closeModal()"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-2xl mx-auto rounded-2xl shadow-lg z-50 overflow-y-auto">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3">
                    <p id="modal-title" class="text-2xl font-bold"></p>
                    <div class="modal-close cursor-pointer z-50" onclick="closeModal()">
                        <svg class="fill-current text-black" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18"><path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path></svg>
                    </div>
                </div>
                <div id="modal-body" class="my-5"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, getDoc, deleteDoc, getDocs, collection, onSnapshot, query, where, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // *******************************************************************
        // CONFIGURACIÓN DE FIREBASE
        const firebaseConfig = {
          apiKey: "AIzaSyCu7P0nV5vSeqvwLtfUpHIpnAgGu9Dx3mY",
          authDomain: "control-asistencia-pruebas.firebaseapp.com",
          projectId: "control-asistencia-pruebas",
          storageBucket: "control-asistencia-pruebas.firebasestorage.app",
          messagingSenderId: "429481399686",
          appId: "1:429481399686:web:955659d3e70826b22a0807",
          measurementId: "G-104TMJF8R4"
        };
        // *******************************************************************

        // --- EMAILS AUTORIZADOS ---
        // Deja vacío [] si quieres permitir a todos, o pon emails: ["tu@email.com"]
        const AUTHORIZED_EMAILS = [
            "donraulvp@gmail.com", 
            "director@colegio.com" 
        ];

        let app, auth, db, userId;
        let qrInterval;
        let generalReportDataForExport = null;
        let allTeachersList = []; // Para el registro manual
        let currentMeetingDataForPrint = null; // Para imprimir
        
        document.addEventListener('DOMContentLoaded', () => {
             // Comprobación de seguridad
             if (!firebaseConfig.apiKey || firebaseConfig.apiKey.includes("API_KEY")) {
                document.getElementById('loading-screen').innerHTML = `<div class="bg-white p-8 rounded-lg shadow-xl text-center"><h2 class="text-2xl font-bold text-red-600">Error de Configuración</h2><p class="mt-4 text-gray-700">La configuración de Firebase no es correcta.</p></div>`;
                return;
             }

            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            onAuthStateChanged(auth, async (user) => {
                const params = new URLSearchParams(window.location.search);
                const isTeacherLink = params.has('meeting');

                if (user) {
                    userId = user.uid;
                    // Si es un usuario anónimo (profesor) o un usuario de Google (admin)
                    if (user.isAnonymous) {
                        initializeAppState(); // Flujo profesor/anónimo
                    } else {
                        // Flujo Administrador (Google)
                        // Verificación de email autorizado
                        if (AUTHORIZED_EMAILS.length > 0 && !AUTHORIZED_EMAILS.includes(user.email)) {
                            await signOut(auth);
                            alert("Acceso denegado: Tu correo (" + user.email + ") no está autorizado para acceder al panel de dirección.");
                            showView('role-selection-view');
                            document.getElementById('loading-screen').style.display = 'none';
                            return;
                        }
                        
                        document.getElementById('admin-email-display').textContent = user.email;
                        initializeAppState(); // Flujo admin autorizado
                    }
                } else {
                    // No logueado
                    if (isTeacherLink) {
                        // Si es enlace de profesor, logueamos anónimamente automático
                        try {
                            await signInAnonymously(auth);
                        } catch (error) {
                            console.error("Auth Error:", error);
                            document.getElementById('loading-screen').innerHTML = `Error de conexión.`;
                        }
                    } else {
                        // Si es la home, esperamos a que pulse el botón de Google
                        document.getElementById('loading-screen').style.display = 'none';
                        showView('role-selection-view');
                    }
                }
            });
        });
        
        // --- AUTENTICACIÓN ADMIN ---
        window.loginWithGoogle = async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Login failed", error);
                const errorDiv = document.getElementById('login-error');
                errorDiv.textContent = "Error al iniciar sesión: " + error.message;
                errorDiv.classList.remove('hidden');
                // IMPORTANTE: Avisar si el dominio no está autorizado
                if (error.code === 'auth/unauthorized-domain') {
                    alert("Este dominio no está autorizado en Firebase. Añádelo en la consola de Firebase > Authentication > Settings.");
                }
            }
        };

        window.logout = async () => {
            await signOut(auth);
            window.location.reload();
        };

        // --- FUNCIONALIDAD DE RESET (NUEVO) ---
        window.resetTestData = async () => {
            if(!confirm("⚠️ ¡ATENCIÓN! ⚠️\n\n¿Estás seguro de que quieres BORRAR TODOS LOS DATOS?\n\nSe eliminarán todas las reuniones, profesores y registros de asistencia. Esta acción no se puede deshacer.")) return;
            if(!confirm("Confirmación final: ¿Realmente quieres eliminar toda la base de datos de pruebas?")) return;

            const loading = document.getElementById('loading-screen');
            loading.style.display = 'flex';
            loading.innerHTML = '<div class="text-white text-center"><div class="lds-dual-ring"></div><p class="mt-4">Borrando datos, por favor espera...</p></div>';

            try {
                // 1. Borrar Reuniones y sus subcolecciones
                const meetingsSnap = await getDocs(collection(db, 'meetings'));
                for(const mDoc of meetingsSnap.docs) {
                    // Borrar asistentes
                    const attendeesSnap = await getDocs(collection(db, `meetings/${mDoc.id}/attendees`));
                    for(const aDoc of attendeesSnap.docs) await deleteDoc(aDoc.ref);
                    
                    // Borrar tokens
                    const tokensSnap = await getDocs(collection(db, `meetings/${mDoc.id}/validTokens`));
                    for(const tDoc of tokensSnap.docs) await deleteDoc(tDoc.ref);

                    // Borrar reunión
                    await deleteDoc(mDoc.ref);
                }

                // 2. Borrar Profesores y sus subcolecciones
                const teachersSnap = await getDocs(collection(db, 'teachers'));
                for(const tDoc of teachersSnap.docs) {
                    // Borrar asistencias del profesor
                    const attSnap = await getDocs(collection(db, `teachers/${tDoc.id}/attendedMeetings`));
                    for(const amDoc of attSnap.docs) await deleteDoc(amDoc.ref);

                    // Borrar profesor
                    await deleteDoc(tDoc.ref);
                }

                alert("Todos los datos han sido eliminados correctamente.");
                window.location.reload();

            } catch (error) {
                console.error("Error al resetear:", error);
                alert("Hubo un error al intentar borrar los datos. Revisa la consola.");
                loading.style.display = 'none';
            }
        }

        function initializeAppState() {
            document.getElementById('loading-screen').style.display = 'none';
            setupUIFromURL();
        }

        function setupUIFromURL() {
            const params = new URLSearchParams(window.location.search);
            if (params.has('meeting') && params.has('token')) {
                // Flujo de profesor (QR escaneado)
                validateTokenAndShowTeacherView(params.get('meeting'), params.get('token'));
            } else {
                // Flujo de administración
                // Si llegamos aquí y estamos logueados (y no es anónimo), mostramos admin
                if (auth.currentUser && !auth.currentUser.isAnonymous) {
                    showView('admin-view');
                    listenForMeetings();
                    listenForTeachers();
                } else {
                    // Si estamos logueados como anónimo pero sin parámetros de reunión, 
                    // probablemente es un residuo, hacemos logout o mostramos home
                    if (auth.currentUser?.isAnonymous) {
                        // Opcional: signOut(auth);
                        showView('role-selection-view');
                    } else {
                        showView('role-selection-view');
                    }
                }
            }
        }
        
        window.showView = (viewId) => {
            ['role-selection-view', 'admin-view', 'teacher-view'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
        };

        window.showTab = (tabId) => {
            const tabs = ['individual-report', 'general-report'];
            tabs.forEach(id => {
                document.getElementById(`${id}-content`).classList.add('hidden');
                document.getElementById(`tab-${id}`).classList.remove('border-indigo-500', 'text-indigo-600');
                document.getElementById(`tab-${id}`).classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            });
            document.getElementById(`${tabId}-content`).classList.remove('hidden');
            document.getElementById(`tab-${tabId}`).classList.add('border-indigo-500', 'text-indigo-600');
            document.getElementById(`tab-${tabId}`).classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
        }

        async function validateTokenAndShowTeacherView(meetingId, tokenId) {
            showView('teacher-view');
            const statusDiv = document.getElementById('teacher-status-message');
            statusDiv.innerHTML = '<div class="lds-dual-ring" style="border-color: #4f46e5 transparent #4f46e5 transparent;"></div><p class="mt-4">Validando código QR...</p>';

            const tokenRef = doc(db, `meetings/${meetingId}/validTokens/${tokenId}`);
            const tokenSnap = await getDoc(tokenRef);

            if (tokenSnap.exists() && tokenSnap.data().expiresAt.toMillis() > Date.now()) {
                await deleteDoc(tokenRef);
                const meetingRef = doc(db, `meetings/${meetingId}`);
                const meetingSnap = await getDoc(meetingRef);
                const meetingName = meetingSnap.exists() ? meetingSnap.data().name : 'Reunión desconocida';
                const savedName = localStorage.getItem('teacherName');
                
                // Precarga para el autocompletado si no tiene nombre guardado
                let teachersDatalist = '';
                if (!savedName) {
                    try {
                        const teachersSnap = await getDocs(collection(db, 'teachers'));
                        const teacherNames = teachersSnap.docs.map(d => d.data().name).sort();
                        teachersDatalist = `<datalist id="teacher-suggestions">${teacherNames.map(n => `<option value="${n}">`).join('')}</datalist>`;
                    } catch(e) { console.log("No se pudo cargar la lista sugerida", e); }
                }

                if (savedName) {
                    statusDiv.innerHTML = `
                        <!-- LOGO DEL CENTRO -->
                        <img src="https://web.virgendelpasico.net/wp-content/uploads/2024/01/cropped-ncoop-scaled-1-300x253.jpg" alt="Logo Virgen del Pasico" class="app-logo">
                        <p class="text-xl font-semibold mb-4 text-gray-700">Asistencia para: "${meetingName}"</p>
                        <p class="text-2xl text-gray-800 mb-2">¿Eres <strong class="font-bold">${savedName}</strong>?</p>
                        <p class="text-gray-500 mb-6">Confirma para registrar tu asistencia.</p>
                        <button id="confirm-btn" onclick="recordAttendance('${meetingId}', true, this)" class="w-full max-w-md mx-auto bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition-colors text-lg">Sí, confirmar asistencia</button>
                        <button onclick="showChangeTeacherForm('${meetingId}', '${meetingName}')" class="mt-4 text-sm text-indigo-600 hover:underline">No soy yo / Cambiar nombre</button>
                    `;
                } else {
                    showChangeTeacherForm(meetingId, meetingName, teachersDatalist);
                }
            } else {
                statusDiv.innerHTML = '<p class="text-red-500 font-bold text-xl">Código QR caducado o inválido. Por favor, escanea el código actual en la pantalla.</p>';
            }
        }

        window.showChangeTeacherForm = async (meetingId, meetingName, preloadedDatalist = '') => {
             // Si no viene precargado (caso de cambio manual), intentamos cargar la lista
             if (!preloadedDatalist) {
                 try {
                    const teachersSnap = await getDocs(collection(db, 'teachers'));
                    const teacherNames = teachersSnap.docs.map(d => d.data().name).sort();
                    preloadedDatalist = `<datalist id="teacher-suggestions">${teacherNames.map(n => `<option value="${n}">`).join('')}</datalist>`;
                 } catch(e) {}
             }

             document.getElementById('teacher-status-message').innerHTML = `
                <!-- LOGO DEL CENTRO -->
                <img src="https://web.virgendelpasico.net/wp-content/uploads/2024/01/cropped-ncoop-scaled-1-300x253.jpg" alt="Logo Virgen del Pasico" class="app-logo">
                <p class="text-xl font-semibold mb-4 text-gray-700">Asistencia para: "${meetingName}"</p>
                <p class="text-gray-600 mb-6">Introduce tu nombre completo:</p>
                <input type="text" id="teacher-name-input" list="teacher-suggestions" placeholder="Empieza a escribir tu nombre..." class="w-full max-w-md mx-auto p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none mb-6">
                ${preloadedDatalist}
                <button id="confirm-new-btn" onclick="recordAttendance('${meetingId}', false, this)" class="w-full max-w-md mx-auto bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition-colors text-lg">Confirmar Asistencia</button>
            `;
            const input = document.getElementById('teacher-name-input');
            input.value = localStorage.getItem('teacherName') || '';
            input.focus();
        }

        window.recordAttendance = async (meetingId, isRecognized, buttonEl) => {
            const originalButtonText = buttonEl.innerHTML;
            buttonEl.disabled = true;
            buttonEl.innerHTML = `<span class="animate-pulse">Registrando...</span>`;

            let name;
            if (isRecognized) {
                name = localStorage.getItem('teacherName');
            } else {
                const nameInput = document.getElementById('teacher-name-input');
                name = nameInput.value.trim();
                if (!name) {
                    nameInput.classList.add('border-red-500');
                    setTimeout(() => nameInput.classList.remove('border-red-500'), 2000);
                    buttonEl.disabled = false;
                    buttonEl.innerHTML = originalButtonText;
                    return;
                }
            }

            // Obtener o crear ID de profesor
            let teacherId = localStorage.getItem('teacherId');
            
            // Intento de buscar ID existente si el nombre coincide con la base de datos (para unificar)
            if (!teacherId || !isRecognized) {
                const teachersCol = collection(db, `teachers`);
                const q = query(teachersCol, where("name", "==", name));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    const newTeacherRef = await addDoc(teachersCol, { name: name });
                    teacherId = newTeacherRef.id;
                } else {
                    teacherId = querySnapshot.docs[0].id;
                }
            }

            const meetingRef = doc(db, `meetings/${meetingId}`);
            const meetingSnap = await getDoc(meetingRef);
            if (!meetingSnap.exists()) {
                 buttonEl.disabled = false;
                 buttonEl.innerHTML = "Error: Reunión no encontrada";
                 return;
            }
            const meetingData = meetingSnap.data();

            try {
                // Verificar duplicados
                const existingAttendanceQuery = query(collection(db, `meetings/${meetingId}/attendees`), where("teacherId", "==", teacherId));
                const existingSnapshot = await getDocs(existingAttendanceQuery);

                if (!existingSnapshot.empty) {
                    document.getElementById('teacher-status-message').innerHTML = `
                        <div class="text-yellow-500 mb-4"><svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg></div>
                        <h2 class="text-2xl font-bold mb-2 text-gray-800">Ya registrado</h2>
                        <p class="text-gray-600">Ya constas en la lista de "${meetingData.name}".</p>
                    `;
                    return;
                }

                await addDoc(collection(db, `meetings/${meetingId}/attendees`), { name, teacherId, timestamp: serverTimestamp() });
                await setDoc(doc(db, `teachers/${teacherId}/attendedMeetings/${meetingId}`), { meetingName: meetingData.name, meetingDate: meetingData.createdAt });
                
                localStorage.setItem('teacherName', name);
                localStorage.setItem('teacherId', teacherId);
                
                document.getElementById('teacher-status-message').innerHTML = `
                    <svg class="mx-auto h-16 w-16 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <h2 class="text-2xl font-bold mt-4">¡Asistencia Registrada!</h2>
                    <p class="text-gray-600 mt-2">Gracias por confirmar tu asistencia a "${meetingData.name}".</p>`;
            } catch (error) { 
                console.error("Registro fallido", error); 
                buttonEl.disabled = false; 
                buttonEl.innerHTML = originalButtonText;
            }
        };

        // --- LÓGICA ADMIN (QR, Listas, Informes) ---
        const QR_LIFESPAN_MS = 30000;
        window.showQrCode = (meetingId, meetingName) => {
            document.getElementById('modal-title').textContent = `QR para: ${meetingName}`;
            const modalBody = document.getElementById('modal-body');
            modalBody.innerHTML = `
                <!-- LOGO DEL CENTRO -->
                <img src="https://web.virgendelpasico.net/wp-content/uploads/2024/01/cropped-ncoop-scaled-1-300x253.jpg" alt="Logo Virgen del Pasico" class="app-logo">

                <p class="text-center text-gray-600 mb-4">Escanea para firmar. Se actualiza cada ${QR_LIFESPAN_MS / 1000}s.</p>
                <div id="qrcode-container" class="flex justify-center p-4 bg-white border rounded-lg relative">
                    <div id="qrcode"></div>
                    <p id="qr-expired-text" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-90 text-red-500 font-bold hidden">CADUCADO</p>
                </div>
                <div class="mt-2 h-1 bg-gray-200 rounded-full overflow-hidden"><div id="qr-timer-bar"></div></div>`;
            openModal();

            const generateAndDisplayDynamicQR = async () => {
                const expiredText = document.getElementById('qr-expired-text');
                if (expiredText) expiredText.classList.remove('hidden');
                
                const tokenId = crypto.randomUUID();
                const expiresAt = Timestamp.fromMillis(Date.now() + QR_LIFESPAN_MS);
                await setDoc(doc(db, `meetings/${meetingId}/validTokens`, tokenId), { expiresAt });
                
                const url = `${window.location.href.split('?')[0]}?meeting=${meetingId}&token=${tokenId}`;
                const qrContainer = document.getElementById('qrcode');
                if(qrContainer) {
                    qrContainer.innerHTML = '';
                    new QRCode(qrContainer, { text: url, width: 256, height: 256 });
                }
                 if (expiredText) expiredText.classList.add('hidden');
                 const timerBar = document.getElementById('qr-timer-bar');
                 if(timerBar) {
                    timerBar.style.transition = 'none';
                    timerBar.style.width = '100%';
                    timerBar.offsetHeight; 
                    timerBar.style.transition = `width ${QR_LIFESPAN_MS / 1000}s linear`;
                    timerBar.style.width = '0%';
                 }
            };
            generateAndDisplayDynamicQR();
            qrInterval = setInterval(generateAndDisplayDynamicQR, QR_LIFESPAN_MS);
        };

        window.closeModal = () => {
            clearInterval(qrInterval);
            document.getElementById('modal').classList.add('hidden');
            document.body.classList.remove('modal-active');
        };

        window.createMeeting = async () => {
            const name = document.getElementById('meeting-name').value.trim();
            if (!name) return;
            try {
                await addDoc(collection(db, `meetings`), { name, createdAt: serverTimestamp(), createdBy: userId });
                document.getElementById('meeting-name').value = '';
            } catch (error) { console.error("Error creating meeting: ", error); }
        };
        
        window.deleteMeeting = async (meetingId) => {
            if(!confirm("¿Borrar esta sesión? Se perderá el acceso a la lista desde aquí.")) return;
            try { await deleteDoc(doc(db, `meetings/${meetingId}`)); } catch (error) { alert("Error al borrar"); }
        }

        // Nueva función para abrir el modal de gestión de profesores
        window.openTeacherManagement = () => {
            document.getElementById('modal-title').textContent = "Gestión del Claustro";
            document.getElementById('modal-body').innerHTML = `
                <div class="p-1">
                    <p class="text-sm text-gray-600 mb-4">Pega aquí la lista de profesores (uno por línea) para precargarla en el sistema. Esto ayudará a que el nombre salga sugerido al registrarse.</p>
                    <div class="flex flex-col gap-2">
                        <textarea id="bulk-teachers" rows="10" placeholder="Ejemplo:\nJuan Pérez García\nMaría López Martínez..." class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none w-full text-sm"></textarea>
                        <button onclick="importTeachers(this)" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors self-end text-sm">Importar Lista</button>
                    </div>
                </div>
            `;
            openModal();
        };

        function listenForMeetings() {
            onSnapshot(query(collection(db, `meetings`)), (snapshot) => {
                const list = document.getElementById('meetings-list');
                const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => b.createdAt?.toMillis() - a.createdAt?.toMillis());
                list.innerHTML = data.map(m => `
                    <div class="flex flex-col md:flex-row justify-between items-center p-4 border rounded-lg bg-gray-50">
                        <div class="mb-2 md:mb-0"><p class="font-bold text-indigo-700">${m.name}</p><p class="text-xs text-gray-500">${m.createdAt ? new Date(m.createdAt.toDate()).toLocaleString('es-ES') : ''}</p></div>
                        <div class="flex gap-2">
                            <button onclick="showQrCode('${m.id}', '${m.name}')" class="bg-indigo-100 text-indigo-700 text-sm font-bold py-2 px-3 rounded hover:bg-indigo-200">QR</button>
                            <button onclick="viewAttendance('${m.id}', '${m.name}')" class="bg-blue-100 text-blue-700 text-sm font-bold py-2 px-3 rounded hover:bg-blue-200">Lista</button>
                            <button onclick="deleteMeeting('${m.id}')" class="text-red-400 hover:text-red-600"><svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                        </div>
                    </div>`).join('');
            });
        }
        
        function listenForTeachers() {
            onSnapshot(query(collection(db, `teachers`)), (snapshot) => {
                const teachers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => a.name.localeCompare(b.name));
                allTeachersList = teachers;
                document.getElementById('teacher-select').innerHTML = teachers.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            });
        }
        
        window.importTeachers = async (btn) => {
            const textarea = document.getElementById('bulk-teachers');
            const text = textarea.value.trim();
            if(!text) return alert("Pega una lista de nombres");
            
            const names = text.split('\n').map(n => n.trim()).filter(n => n.length > 0);
            if(names.length === 0) return alert("No hay nombres válidos");
            
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = "Importando...";
            
            try {
                const existingSnap = await getDocs(collection(db, 'teachers'));
                const existingNames = new Set(existingSnap.docs.map(d => d.data().name.toLowerCase()));
                
                let added = 0;
                for(const name of names) {
                    if(!existingNames.has(name.toLowerCase())) {
                        await addDoc(collection(db, 'teachers'), {name});
                        added++;
                    }
                }
                alert(`Importación completada. ${added} profesores nuevos añadidos.`);
                textarea.value = "";
                closeModal(); // Cerrar modal tras importar
            } catch(e) {
                console.error(e);
                alert("Error durante la importación.");
            }
            btn.disabled = false;
            btn.innerHTML = originalText;
        };
        
        window.selectAllTeachers = (val) => {
            const opts = document.getElementById('teacher-select').options;
            for(let i=0; i<opts.length; i++) opts[i].selected = val;
        }

        window.getTeacherAttendance = async () => {
            const selectedIds = Array.from(document.getElementById('teacher-select').selectedOptions).map(o => o.value);
            const start = document.getElementById('start-date').value;
            const end = document.getElementById('end-date').value;
            const resDiv = document.getElementById('teacher-attendance-results');
            
            if (selectedIds.length === 0) { resDiv.innerHTML = '<p class="text-red-500">Selecciona profesor(es).</p>'; return; }
            resDiv.innerHTML = '<p>Buscando...</p>';
            
            let allData = [];
            for (const tid of selectedIds) {
                const tName = document.getElementById('teacher-select').querySelector(`option[value="${tid}"]`).text;
                let q = query(collection(db, `teachers/${tid}/attendedMeetings`));
                if (start) q = query(q, where("meetingDate", ">=", Timestamp.fromDate(new Date(start))));
                if (end) { const e = new Date(end); e.setHours(23,59,59); q = query(q, where("meetingDate", "<=", Timestamp.fromDate(e))); }
                const snap = await getDocs(q);
                allData.push(...snap.docs.map(d => ({...d.data(), teacherName: tName})));
            }
            
            if (allData.length === 0) { resDiv.innerHTML = '<p class="text-gray-500">Sin resultados.</p>'; return; }
            
            const grouped = allData.reduce((acc, i) => { (acc[i.teacherName] = acc[i.teacherName] || []).push(i); return acc; }, {});
            let html = '';
            for(const name in grouped) {
                html += `<div class="mb-4 bg-gray-50 p-3 rounded"><h4 class="font-bold text-indigo-700">${name} (${grouped[name].length})</h4><ul class="text-sm text-gray-600 pl-4 list-disc">${grouped[name].map(i => `<li>${i.meetingName} <span class="text-xs text-gray-400">(${new Date(i.meetingDate.toDate()).toLocaleDateString()})</span></li>`).join('')}</ul></div>`;
            }
            window.teacherReportDataForExport = allData;
            html += `<button onclick="exportTeacherAttendanceToCSV()" class="w-full bg-green-500 text-white font-bold py-2 rounded mt-2">Exportar CSV</button>`;
            resDiv.innerHTML = html;
        };

        window.exportTeacherAttendanceToCSV = () => {
            const data = window.teacherReportDataForExport;
            let csv = "Profesor,Reunion,Fecha\n" + data.map(i => `"${i.teacherName}","${i.meetingName}","${new Date(i.meetingDate.seconds*1000).toLocaleString()}"`).join("\n");
            const link = document.createElement("a"); link.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv); link.download = `informe_profesores.csv`; link.click();
        };

        // -------------------------
        // NUEVA FUNCIÓN DE IMPRESIÓN
        // -------------------------
        window.printAttendanceList = () => {
            if (!currentMeetingDataForPrint) return;
            const { name, attendees } = currentMeetingDataForPrint;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Asistencia - ${name}</title>
                    <style>
                        body { font-family: 'Inter', sans-serif; padding: 40px; color: #333; }
                        h1 { text-align: center; color: #333; font-size: 24px; margin-bottom: 5px; }
                        .subtitle { text-align: center; color: #666; font-size: 14px; margin-bottom: 30px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
                        th, td { border-bottom: 1px solid #ddd; padding: 12px 8px; text-align: left; }
                        th { background-color: #f9fafb; font-weight: bold; text-transform: uppercase; font-size: 12px; color: #6b7280; }
                        tr:nth-child(even) { background-color: #f9fafb; }
                        .footer { margin-top: 30px; border-top: 2px solid #333; padding-top: 10px; display: flex; justify-content: space-between; font-weight: bold; }
                        .logo { display: block; margin: 0 auto 20px; height: 80px; width: auto; }
                        @media print {
                            body { -webkit-print-color-adjust: exact; }
                        }
                    </style>
                </head>
                <body>
                    <img src="https://web.virgendelpasico.net/wp-content/uploads/2024/01/cropped-ncoop-scaled-1-300x253.jpg" class="logo" alt="Logo">
                    <h1>Lista de Asistencia</h1>
                    <div class="subtitle">Evento: <strong>${name}</strong> &bull; Fecha de impresión: ${new Date().toLocaleDateString()}</div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Nombre del Profesor</th>
                                <th style="text-align:right">Hora de Registro</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${attendees.map((a, index) => `
                                <tr>
                                    <td style="width: 30px; color: #999;">${index + 1}</td>
                                    <td>${a.name}</td>
                                    <td style="text-align:right">${a.timestamp ? new Date(a.timestamp.seconds * 1000).toLocaleTimeString('es-ES') : '--:--'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <span>Firma / Sello del Centro:</span>
                        <span>Total Asistentes: ${attendees.length}</span>
                    </div>
                    
                    <script>
                        window.onload = function() { 
                            window.print(); 
                            // window.close(); // Opcional: cerrar tras imprimir
                        }
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        };

        window.viewAttendance = (mId, mName) => {
            document.getElementById('modal-title').textContent = mName;
            
            // Se inyecta botón de Imprimir en la cabecera
            document.getElementById('modal-body').innerHTML = `
                <div class="flex justify-end mb-4">
                     <button onclick="printAttendanceList()" id="btn-print-list" disabled class="flex items-center gap-2 text-sm bg-white text-gray-700 hover:text-gray-900 border border-gray-300 hover:bg-gray-50 py-2 px-4 rounded-lg shadow-sm transition-colors opacity-50 cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                        </svg>
                        Imprimir Lista
                     </button>
                </div>
                
                <div class="bg-indigo-50 p-3 rounded mb-4 text-sm">
                    <div class="flex gap-2"><select id="manual-teacher-select" class="flex-grow border rounded p-1"><option value="">-- Añadir manual --</option>${allTeachersList.map(t=>`<option value="${t.name}">${t.name}</option>`).join('')}</select></div>
                    <div class="flex gap-2 mt-2"><input id="manual-teacher-name" placeholder="O nuevo nombre..." class="flex-grow border rounded p-1"><button onclick="manualRecordAttendance('${mId}')" class="bg-indigo-600 text-white px-3 rounded">Añadir</button></div>
                </div>
                <div id="attendance-list-container">Cargando...</div>`;
            openModal();
            
            onSnapshot(query(collection(db, `meetings/${mId}/attendees`)), (snap) => {
                const list = document.getElementById('attendance-list-container');
                if(!list) return;
                const data = snap.docs.map(d => d.data()).sort((a,b) => a.timestamp - b.timestamp);
                
                // GUARDAR DATOS GLOBALES PARA IMPRIMIR
                currentMeetingDataForPrint = { name: mName, attendees: data };
                
                // Activar botón de imprimir
                const btnPrint = document.getElementById('btn-print-list');
                if(btnPrint) {
                    btnPrint.disabled = false;
                    btnPrint.classList.remove('opacity-50', 'cursor-not-allowed');
                }

                list.innerHTML = `<p class="mb-2 font-bold">Total: ${data.length}</p><ul class="max-h-60 overflow-y-auto">${data.map(a => `<li class="flex justify-between border-b py-2"><span>${a.name}</span><span class="text-xs text-gray-400">${a.timestamp?.toDate().toLocaleTimeString()||''}</span></li>`).join('')}</ul>`;
            });
        }

        window.manualRecordAttendance = async (mId) => {
            const sel = document.getElementById('manual-teacher-select');
            const inp = document.getElementById('manual-teacher-name');
            const name = sel.value || inp.value.trim();
            if(!name) return alert("Elige o escribe un nombre");
            
            // Buscar/Crear teacher
            let tid;
            const q = query(collection(db,'teachers'), where("name","==",name));
            const snap = await getDocs(q);
            if(snap.empty) { const ref = await addDoc(collection(db,'teachers'),{name}); tid = ref.id; }
            else tid = snap.docs[0].id;

            // Registrar
            const mRef = await getDoc(doc(db,`meetings/${mId}`));
            const mData = mRef.data();
            try {
                await addDoc(collection(db,`meetings/${mId}/attendees`),{name, teacherId:tid, timestamp: serverTimestamp()});
                await setDoc(doc(db,`teachers/${tid}/attendedMeetings/${mId}`),{meetingName:mData.name, meetingDate:mData.createdAt});
                alert("Añadido");
            } catch(e) { console.error(e); alert("Error"); }
        }

        // --- NUEVAS FUNCIONES PARA INFORME GENERAL ---
        window.getGeneralAttendance = async () => {
            const startDate = document.getElementById('general-start-date').value;
            const endDate = document.getElementById('general-end-date').value;
            const resultsDiv = document.getElementById('general-attendance-results');
            resultsDiv.innerHTML = '<p>Generando informe, esto puede tardar unos segundos...</p>';

            const teachersSnap = await getDocs(collection(db, 'teachers'));
            const teachers = teachersSnap.docs.map(doc => ({ id: doc.id, name: doc.data().name }));
            teachers.sort((a, b) => a.name.localeCompare(b.name));

            let meetingsQuery = query(collection(db, 'meetings'));
            if (startDate) meetingsQuery = query(meetingsQuery, where("createdAt", ">=", Timestamp.fromDate(new Date(startDate))));
            if (endDate) {
                 const endOfDay = new Date(endDate);
                 endOfDay.setHours(23, 59, 59, 999);
                 meetingsQuery = query(meetingsQuery, where("createdAt", "<=", Timestamp.fromDate(endOfDay)));
            }
            const meetingsSnap = await getDocs(meetingsQuery);
            const meetings = meetingsSnap.docs.map(doc => ({ id: doc.id, name: doc.data().name, date: doc.data().createdAt.toDate() }));
            meetings.sort((a, b) => a.date - b.date);

            const attendancePromises = teachers.map(async (teacher) => {
                const attendedMeetingsSnap = await getDocs(collection(db, `teachers/${teacher.id}/attendedMeetings`));
                const attendedMeetingIds = new Set(attendedMeetingsSnap.docs.map(doc => doc.id));
                return { ...teacher, attendedMeetingIds };
            });

            const fullReportData = await Promise.all(attendancePromises);

            // Guardar datos para exportar
            generalReportDataForExport = {report: fullReportData, meetings: meetings.map(m => ({...m, date: m.date.toISOString()})) };

            // Botones arriba (movido desde abajo)
            let summaryHtml = `
            <div class="flex gap-2 mb-4">
                <button onclick="exportGeneralAttendanceToCSV()" class="flex-1 bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Exportar CSV</button>
                <button onclick="printGeneralReport()" class="flex-1 bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 flex justify-center items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                    </svg>
                    Imprimir / PDF
                </button>
            </div>
            `;

            // Generar tabla HTML para mostrar en pantalla (simplificada)
            summaryHtml += '<div class="overflow-x-auto"><table class="min-w-full text-xs text-left mt-4 border-collapse">';
            summaryHtml += '<thead><tr><th class="border p-2 bg-gray-100">Profesor</th>';
            meetings.forEach(m => {
                summaryHtml += `<th class="border p-2 bg-gray-100 font-normal"><div class="transform -rotate-45 origin-bottom-left translate-x-4 mb-2" style="height: 80px; width: 20px;">${m.name}<br><span class="text-xs text-gray-500">${m.date.toLocaleDateString()}</span></div></th>`;
            });
            summaryHtml += '<th class="border p-2 bg-gray-100 font-bold">Total</th></tr></thead><tbody>';
            
            fullReportData.forEach(teacherData => {
                const attendedCount = [...teacherData.attendedMeetingIds].filter(id => meetings.some(m => m.id === id)).length;
                summaryHtml += `<tr><td class="border p-2 font-medium">${teacherData.name}</td>`;
                meetings.forEach(meeting => {
                    if(teacherData.attendedMeetingIds.has(meeting.id)) {
                        summaryHtml += '<td class="border p-2 text-center bg-green-100 text-green-800 font-bold">X</td>';
                    } else {
                        summaryHtml += '<td class="border p-2"></td>';
                    }
                });
                summaryHtml += `<td class="border p-2 text-center font-bold">${attendedCount}</td></tr>`;
            });
            summaryHtml += '</tbody></table></div>';

            resultsDiv.innerHTML = summaryHtml;
        };
        
        window.printGeneralReport = () => {
            if (!generalReportDataForExport) return;
            const { report, meetings } = generalReportDataForExport;
            const start = document.getElementById('general-start-date').value;
            const end = document.getElementById('general-end-date').value;
            const dateRange = start && end ? `Desde ${new Date(start).toLocaleDateString()} hasta ${new Date(end).toLocaleDateString()}` : 'Informe Completo';

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Informe General de Asistencia</title>
                    <style>
                        body { font-family: 'Inter', sans-serif; padding: 20px; color: #333; }
                        .header { text-align: center; margin-bottom: 20px; }
                        .logo { height: 60px; margin-bottom: 10px; }
                        h1 { font-size: 20px; margin: 0; }
                        .subtitle { font-size: 12px; color: #666; margin-top: 5px; }
                        table { width: 100%; border-collapse: collapse; font-size: 10px; margin-top: 20px; }
                        th, td { border: 1px solid #ccc; padding: 4px; text-align: center; }
                        th.rotate { height: 100px; white-space: nowrap; }
                        th.rotate > div { transform: translate(0px, 40px) rotate(270deg); width: 20px; margin: 0 auto; }
                        th.name-col { text-align: left; width: 150px; }
                        td.name-col { text-align: left; font-weight: bold; }
                        .attended { background-color: #d1fae5; color: #065f46; font-weight: bold; }
                        .footer { margin-top: 30px; border-top: 1px solid #333; padding-top: 10px; font-size: 10px; display: flex; justify-content: space-between; }
                        @media print {
                            @page { size: landscape; } /* Force landscape for wide tables */
                            body { -webkit-print-color-adjust: exact; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <img src="https://web.virgendelpasico.net/wp-content/uploads/2024/01/cropped-ncoop-scaled-1-300x253.jpg" class="logo" alt="Logo">
                        <h1>Informe General de Asistencia</h1>
                        <div class="subtitle">${dateRange}</div>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th class="name-col">Profesor</th>
                                ${meetings.map(m => `<th>${m.name}<br><span style="font-weight:normal">${new Date(m.date).toLocaleDateString()}</span></th>`).join('')}
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${report.map(t => {
                                let count = 0;
                                const row = `<tr>
                                    <td class="name-col">${t.name}</td>
                                    ${meetings.map(m => {
                                        if (t.attendedMeetingIds.has(m.id)) { // Changed from t.attended to t.attendedMeetingIds based on getGeneralAttendance logic
                                            count++;
                                            return '<td class="attended">X</td>';
                                        } else {
                                            return '<td></td>';
                                        }
                                    }).join('')}
                                    <td style="font-weight:bold">${count}</td>
                                </tr>`;
                                return row;
                            }).join('')}
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <span>Firma de Dirección:</span>
                        <span>Fecha de emisión: ${new Date().toLocaleDateString()}</span>
                    </div>
                    
                    <script>
                        window.onload = function() { window.print(); }
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        window.exportGeneralAttendanceToCSV = () => {
            if (!generalReportDataForExport) {
                console.error("No hay datos para exportar.");
                return;
            }
            const { report, meetings } = generalReportDataForExport;
            
            let csvContent = "Profesor,";
            meetings.forEach(meeting => {
                csvContent += `"${meeting.name} (${new Date(meeting.date).toLocaleDateString('es-ES')})",`;
            });
            csvContent += "Total\n";

            report.forEach(teacherData => {
                csvContent += `"${teacherData.name}",`;
                let total = 0;
                meetings.forEach(meeting => {
                    if (teacherData.attendedMeetingIds.has(meeting.id)) {
                        csvContent += "X,";
                        total++;
                    } else {
                        csvContent += ",";
                    }
                });
                csvContent += `${total}\n`;
            });

            const link = document.createElement("a");
            link.setAttribute("href", 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvContent));
            link.setAttribute("download", `informe_general_asistencia.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        function openModal() { document.getElementById('modal').classList.remove('hidden'); document.body.classList.add('modal-active'); }
        window.closeModal = () => { clearInterval(qrInterval); document.getElementById('modal').classList.add('hidden'); document.body.classList.remove('modal-active'); }
    </script>
</body>
</html>
```
```eof
